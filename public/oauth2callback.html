<!DOCTYPE html>
<html>
<head>
    <title>Autorizaci√≥n Completada</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #088395;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Procesando autorizaci√≥n...</h1>
    <div id="result"></div>

    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h2>Error de autorizaci√≥n</h2>
                        <p>${error}</p>
                        <button onclick="window.location.href='/setup-calendar.html'">Volver</button>
                    </div>
                `;
                return;
            }
            
            if (!code) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <p>No se recibi√≥ c√≥digo de autorizaci√≥n.</p>
                        <button onclick="window.location.href='/setup-calendar.html'">Volver</button>
                    </div>
                `;
                return;
            }
            
            const clientId = sessionStorage.getItem('clientId');
            const clientSecret = sessionStorage.getItem('clientSecret');
            
            if (!clientId || !clientSecret) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h2>Error</h2>
                        <p>No se encontraron las credenciales. Por favor, vuelve a intentar.</p>
                        <button onclick="window.location.href='/setup-calendar.html'">Volver</button>
                    </div>
                `;
                return;
            }
            
            // Intercambiar c√≥digo por tokens
            fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    code: code,
                    client_id: clientId,
                    client_secret: clientSecret,
                    redirect_uri: window.location.origin + '/oauth2callback.html',
                    grant_type: 'authorization_code'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    // Guardar tokens en localStorage autom√°ticamente
                    const tokens = {
                        access_token: data.access_token,
                        refresh_token: data.refresh_token || null,
                        expires_at: Date.now() + (data.expires_in * 1000),
                        expires_in: data.expires_in
                    };
                    
                    const clientConfig = {
                        client_id: clientId,
                        client_secret: clientSecret
                    };
                    
                    try {
                        localStorage.setItem('google_calendar_tokens', JSON.stringify(tokens));
                        localStorage.setItem('google_calendar_client_config', JSON.stringify(clientConfig));
                        
                        document.getElementById('result').innerHTML = `
                            <div class="success">
                                <h2>‚úÖ ¬°Configuraci√≥n exitosa y guardada!</h2>
                                <p>Los tokens se han guardado autom√°ticamente en localStorage.</p>
                                <p><strong>‚úÖ Refresh autom√°tico habilitado:</strong> El token se renovar√° autom√°ticamente cuando expire.</p>
                                
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <h3>üéâ ¬°Listo!</h3>
                                    <p>Ahora puedes:</p>
                                    <ol>
                                        <li>Recargar la aplicaci√≥n</li>
                                        <li>Hacer una reserva de prueba</li>
                                        <li>Verificar que aparezca en tu Google Calendar</li>
                                    </ol>
                                    <p><strong>El token se renovar√° autom√°ticamente</strong> - no necesitas hacer nada m√°s.</p>
                                </div>
                                
                                <details style="margin-top: 20px;">
                                    <summary style="cursor: pointer; font-weight: bold;">üìã Comandos para Firebase Functions (Recomendado)</summary>
                                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                        <p><strong>Para que funcione desde cualquier dispositivo, configura Firebase Functions:</strong></p>
                                        <p style="font-size: 12px; color: #666;">Copia y ejecuta este comando en tu terminal:</p>
                                        <textarea id="firebaseCommand" readonly style="font-size: 11px; height: 120px; font-family: monospace;">firebase functions:config:set \\
  google.client_id="${clientId}" \\
  google.client_secret="${clientSecret}" \\
  google.redirect_uri="${window.location.origin}/oauth2callback.html" \\
  google.access_token="${data.access_token}" \\
  google.refresh_token="${data.refresh_token || 'NO_REFRESH_TOKEN'}"</textarea>
                                        <button onclick="copyToClipboard('firebaseCommand')" style="margin-top: 5px;">üìã Copiar Comando</button>
                                        <p style="font-size: 12px; margin-top: 10px; color: #666;">Despu√©s ejecuta: <code>firebase deploy --only functions</code></p>
                                        <p style="font-size: 11px; color: #888; margin-top: 10px;">üìñ Ver gu√≠a completa en: FIREBASE_FUNCTIONS_SETUP.md</p>
                                    </div>
                                </details>
                                
                                <details style="margin-top: 20px;">
                                    <summary style="cursor: pointer; font-weight: bold;">Ver tokens (para referencia)</summary>
                                    <p><strong>Access Token:</strong></p>
                                    <textarea id="accessToken" readonly style="font-size: 10px;">${data.access_token}</textarea>
                                    
                                    ${data.refresh_token ? `
                                        <p><strong>Refresh Token:</strong></p>
                                        <textarea id="refreshToken" readonly style="font-size: 10px;">${data.refresh_token}</textarea>
                                    ` : '<p class="warning">‚ö†Ô∏è No se obtuvo refresh token. El access token expirar√° en 1 hora.</p>'}
                                    
                                    <p><strong>Expira en:</strong> ${data.expires_in} segundos (${Math.round(data.expires_in / 3600)} horas)</p>
                                </details>
                                
                                <button onclick="window.location.href='/'" style="margin-top: 20px; background: #088395; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                    Ir a la aplicaci√≥n
                                </button>
                            </div>
                        `;
                    } catch (error) {
                        // Si localStorage no est√° disponible, mostrar tokens para copiar manualmente
                        document.getElementById('result').innerHTML = `
                            <div class="success">
                                <h2>‚úÖ ¬°Configuraci√≥n exitosa!</h2>
                                <p class="warning">‚ö†Ô∏è No se pudo guardar en localStorage. Copia los tokens manualmente:</p>
                                
                                <p><strong>Access Token:</strong></p>
                                <textarea id="accessToken" readonly>${data.access_token}</textarea>
                                <button onclick="copyToClipboard('accessToken')">Copiar Access Token</button>
                                
                                ${data.refresh_token ? `
                                    <p><strong>Refresh Token:</strong></p>
                                    <textarea id="refreshToken" readonly>${data.refresh_token}</textarea>
                                    <button onclick="copyToClipboard('refreshToken')">Copiar Refresh Token</button>
                                ` : '<p class="warning">‚ö†Ô∏è No se obtuvo refresh token.</p>'}
                                
                                <h3>üìù C√≥digo para calendarConfig.js:</h3>
                                <textarea id="configCode" readonly>import { initializeCalendar } from '../firebase/googleCalendar';

const CALENDAR_CONFIG = {
  access_token: '${data.access_token}',
  refresh_token: '${data.refresh_token || 'NO_REFRESH_TOKEN'}'
};

const CLIENT_CONFIG = {
  client_id: '${clientId}',
  client_secret: '${clientSecret}'
};

initializeCalendar(CALENDAR_CONFIG, CLIENT_CONFIG);

export default CALENDAR_CONFIG;</textarea>
                                <button onclick="copyToClipboard('configCode')">Copiar C√≥digo Completo</button>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('result').innerHTML = `
                        <div class="error">
                            <h2>Error obteniendo tokens</h2>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                            <button onclick="window.location.href='/setup-calendar.html'">Volver</button>
                        </div>
                    `;
                }
            })
            .catch(error => {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h2>Error</h2>
                        <pre>${error.message}</pre>
                        <button onclick="window.location.href='/setup-calendar.html'">Volver</button>
                    </div>
                `;
            });
        })();
        
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            document.execCommand('copy');
            alert('¬°Copiado al portapapeles!');
        }
    </script>
</body>
</html>

